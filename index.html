<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Hướng Dẫn Công Thức Pha Chế</title>
<script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-database-compat.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
body {
@@ -215,20 +213,6 @@ <h2 id="modalTitle">Thêm Công Thức</h2>
</footer>

<script>
        // Cấu hình Firebase
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  databaseURL: "https://YOUR_PROJECT_ID.firebaseio.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

// Khởi tạo Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
// Default recipes data
const defaultRecipes = {
feca: [
@@ -293,224 +277,201 @@ <h2 id="modalTitle">Thêm Công Thức</h2>
]
};

       let recipes = {};
        // Load recipes with fallback
        let recipes = defaultRecipes;
        try {
            const storedRecipes = localStorage.getItem('recipes');
            if (storedRecipes) {
                recipes = JSON.parse(storedRecipes);
                console.log('Loaded recipes from localStorage:', recipes);
            } else {
                console.log('No recipes in localStorage, using defaultRecipes');
            }
        } catch (e) {
            console.error('Failed to parse localStorage recipes:', e);
            localStorage.setItem('recipes', JSON.stringify(defaultRecipes));
        }

function generateUUID() {
return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
return v.toString(16);
});
}

        function showMessage(message, type = 'success') {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.remove();
            }, 3000);
        }

        function resetToDefault() {
            if (confirm('Bạn có chắc muốn khôi phục về công thức mặc định? Tất cả thay đổi sẽ bị mất.')) {
                recipes = JSON.parse(JSON.stringify(defaultRecipes));
                saveRecipes();
                renderRecipes();
                showMessage('Đã khôi phục về công thức mặc định!');
            }
        }

function toggleAccordion(button) {
            const content = button.nextElementSibling;
            button.classList.toggle('open');
            content.classList.toggle('open');
            try {
                console.log('Toggling accordion for:', button.textContent);
                const content = button.nextElementSibling;
                if (!content || !content.classList.contains('accordion-content')) {
                    console.error('No valid accordion-content found after button:', button);
                    return;
                }
                const isOpen = content.classList.contains('open');
                content.classList.toggle('open', !isOpen);
                button.classList.toggle('open', !isOpen);
                console.log('Accordion state:', { isOpen: !isOpen, contentHeight: content.scrollHeight });
            } catch (e) {
                console.error('Error in toggleAccordion:', e);
            }
}

function openModal(mode, recipe = null) {
            const modal = document.getElementById('recipeModal');
            const form = document.getElementById('recipeForm');
            const title = document.getElementById('modalTitle');
            
            if (mode === 'edit' && recipe) {
                title.textContent = 'Sửa Công Thức';
                document.getElementById('recipeName').value = recipe.name;
                document.getElementById('recipeSection').value = recipe.section || 'frappe';
                document.getElementById('recipeIngredients').value = recipe.ingredients.join('\n');
                document.getElementById('recipeInstructions').value = recipe.instructions.join('\n');
                document.getElementById('recipeNotes').value = recipe.notes || '';
                document.getElementById('recipeId').value = recipe.id;
            } else {
                title.textContent = 'Thêm Công Thức';
                form.reset();
                document.getElementById('recipeId').value = '';
            }
            try {
                const modal = document.getElementById('recipeModal');
                const form = document.getElementById('recipeForm');
                const title = document.getElementById('modalTitle');
                const recipeName = document.getElementById('recipeName');
                const recipeSection = document.getElementById('recipeSection');
                const recipeIngredients = document.getElementById('recipeIngredients');
                const recipeInstructions = document.getElementById('recipeInstructions');
                const recipeNotes = document.getElementById('recipeNotes');
                const recipeId = document.getElementById('recipeId');

            modal.classList.add('open');
                if (mode === 'edit' && recipe) {
                    title.textContent = 'Sửa Công Thức';
                    recipeName.value = recipe.name;
                    recipeSection.value = recipe.section || 'frappe';
                    recipeIngredients.value = recipe.ingredients.join('\n');
                    recipeInstructions.value = recipe.instructions.join('\n');
                    recipeNotes.value = recipe.notes || '';
                    recipeId.value = recipe.id;
                } else {
                    title.textContent = 'Thêm Công Thức';
                    form.reset();
                    recipeId.value = '';
                }

                modal.classList.add('open');
                console.log(`Opened modal in ${mode} mode`, recipe);
            } catch (e) {
                console.error('Error opening modal:', e);
            }
}

function closeModal() {
            document.getElementById('recipeModal').classList.remove('open');
            try {
                document.getElementById('recipeModal').classList.remove('open');
                console.log('Closed modal');
            } catch (e) {
                console.error('Error closing modal:', e);
            }
}

function renderRecipes() {
            const sections = ['feca', 'coffee', 'frappe', 'matcha', 'tea'];
            
            sections.forEach(section => {
                const container = document.getElementById(`${section}-recipes`);
                if (!container) return;
                
                container.innerHTML = '';
                
                if (!recipes[section] || !Array.isArray(recipes[section])) {
                    container.innerHTML = '<div class="error-message">Không tìm thấy công thức. Vui lòng thêm công thức mới.</div>';
                    return;
                }
                
                recipes[section].forEach(recipe => {
                    const recipeDiv = document.createElement('div');
                    recipeDiv.className = 'bg-white shadow-md rounded-xl overflow-hidden';
                    
                    recipeDiv.innerHTML = `
                        <button class="accordion-button" onclick="toggleAccordion(this)">
                            ${recipe.name}
                        </button>
                        <div class="accordion-content">
                            ${recipe.ingredients.length ? `
                                <p class="font-medium mb-1">Nguyên liệu:</p>
                                <ul class="list-disc pl-6 mb-3">
                                    ${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}
                                </ul>
                            ` : ''}
                            
                            ${recipe.instructions.length ? `
                                <p class="font-medium mb-1">Cách làm:</p>
                                <ul class="list-disc pl-6 mb-3">
                                    ${recipe.instructions.map(ins => `<li>${ins}</li>`).join('')}
                                </ul>
                            ` : ''}
                            
                            ${recipe.notes ? `
                                <p class="font-medium mb-1">Ghi chú:</p>
                                <p class="pl-2">${recipe.notes}</p>
                            ` : ''}
                        </div>
                        <div class="flex justify-end p-2 bg-gray-50 border-t">
                            <button onclick="editRecipe('${recipe.id}', '${section}')" class="text-blue-600 hover:text-blue-800 mr-2 px-3 py-1 rounded hover:bg-blue-50">
                                Sửa
                            </button>
                            <button onclick="deleteRecipe('${recipe.id}', '${section}')" class="text-red-600 hover:text-red-800 px-3 py-1 rounded hover:bg-red-50">
                                Xóa
                            </button>
                        </div>
                    `;
                    
                    container.appendChild(recipeDiv);
            try {
                console.log('Starting renderRecipes');
                const sections = ['feca', 'coffee', 'frappe', 'matcha', 'tea'];
                sections.forEach(section => {
                    const container = document.getElementById(`${section}-recipes`);
                    if (!container) {
                        console.error(`Container ${section}-recipes not found`);
                        return;
                    }
                    container.innerHTML = '';

                    if (!recipes[section] || !Array.isArray(recipes[section])) {
                        console.warn(`No valid recipes for section ${section}`);
                        container.innerHTML = `<div class="error-message">Không tìm thấy công thức cho ${section}. Vui lòng thêm công thức mới.</div>`;
                        return;
                    }

                    recipes[section].forEach(recipe => {
                        const recipeDiv = document.createElement('div');
                        recipeDiv.className = 'bg-white shadow-md rounded-xl overflow-hidden';
                        recipeDiv.innerHTML = `
                            <button class="accordion-button w-full text-left p-5 font-semibold text-lg bg-gradient-to-r from-gray-50 to-gray-100 text-gray-700" onclick="toggleAccordion(this)">${recipe.name}</button>
                            <div class="accordion-content bg-gray-50 text-gray-600">
                                ${recipe.ingredients && recipe.ingredients.length ? `<p><strong>Nguyên liệu:</strong></p><ul class="list-disc pl-6">${recipe.ingredients.map(ing => `<li>${ing}</li>`).join('')}</ul>` : ''}
                                ${recipe.instructions && recipe.instructions.length ? `<p><strong>Cách làm:</strong></p><ul class="list-disc pl-6">${recipe.instructions.map(ins => `<li>${ins}</li>`).join('')}</ul>` : ''}
                                ${recipe.notes ? `<p><strong>Ghi chú:</strong> ${recipe.notes}</p>` : ''}
                            </div>
                            <div class="flex justify-end p-2">
                                <button onclick="editRecipe('${recipe.id}', '${section}')" class="text-blue-600 hover:text-blue-800 mr-2">Sửa</button>
                                <button onclick="deleteRecipe('${recipe.id}', '${section}')" class="text-red-600 hover:text-red-800">Xóa</button>
                            </div>
                        `;
                        container.appendChild(recipeDiv);
                        console.log(`Rendered recipe: ${recipe.name} in ${section}`);
                    });
});
            });
            } catch (e) {
                console.error('Error in renderRecipes:', e);
                const main = document.querySelector('main');
                const errorDiv = document.createElement('div');
                errorDiv.className = 'error-message';
                errorDiv.textContent = 'Có lỗi khi tải công thức. Vui lòng kiểm tra Console để biết chi tiết.';
                main.insertBefore(errorDiv, main.firstChild);
            }
}

function editRecipe(id, section) {
            const recipe = recipes[section].find(r => r.id === id);
            if (recipe) {
                openModal('edit', { ...recipe, section });
            try {
                const recipe = recipes[section].find(r => r.id === id);
                if (recipe) {
                    openModal('edit', { ...recipe, section });
                    console.log(`Editing recipe: ${id} in ${section}`);
                } else {
                    console.error(`Recipe ${id} not found in ${section}`);
                }
            } catch (e) {
                console.error('Error editing recipe:', e);
}
}

function deleteRecipe(id, section) {
            if (confirm('Bạn có chắc muốn xóa công thức này?')) {
                recipes[section] = recipes[section].filter(r => r.id !== id);
                saveRecipes();
                renderRecipes();
                showMessage('Đã xóa công thức!');
            }
        }

        // Hàm lưu recipes lên Firebase
        function saveRecipes() {
            database.ref('recipes').set(recipes)
                .then(() => console.log('Recipes saved to Firebase'))
                .catch((error) => {
                    console.error('Failed to save recipes:', error);
                    showMessage('Lỗi khi lưu công thức', 'error');
                });
        }

        // Hàm load recipes từ Firebase
        function loadRecipes() {
            database.ref('recipes').once('value').then((snapshot) => {
                const data = snapshot.val();
                if (data) {
                    recipes = data;
                    console.log('Loaded recipes from Firebase');
                } else {
                    recipes = JSON.parse(JSON.stringify(defaultRecipes));
                    saveRecipes();
                    console.log('No recipes in Firebase, using default');
            try {
                if (confirm('Bạn có chắc muốn xóa công thức này?')) {
                    recipes[section] = recipes[section].filter(r => r.id !== id);
                    localStorage.setItem('recipes', JSON.stringify(recipes));
                    renderRecipes();
                    console.log(`Deleted recipe: ${id} from ${section}`);
}
                renderRecipes();
            }).catch((error) => {
                console.error('Failed to load recipes:', error);
                recipes = JSON.parse(JSON.stringify(defaultRecipes));
                renderRecipes();
                showMessage('Lỗi khi tải công thức', 'error');
            });
            } catch (e) {
                console.error('Error deleting recipe:', e);
            }
}

        // Xử lý submit form
document.getElementById('recipeForm').addEventListener('submit', function(e) {
e.preventDefault();
            
            const id = document.getElementById('recipeId').value || generateUUID();
            const section = document.getElementById('recipeSection').value;
            const name = document.getElementById('recipeName').value.trim();
            const ingredients = document.getElementById('recipeIngredients').value
                .split('\n')
                .filter(line => line.trim());
            const instructions = document.getElementById('recipeInstructions').value
                .split('\n')
                .filter(line => line.trim());
            const notes = document.getElementById('recipeNotes').value.trim();
            try {
                const id = document.getElementById('recipeId').value || generateUUID();
                const section = document.getElementById('recipeSection').value;
                const name = document.getElementById('recipeName').value;
                const ingredients = document.getElementById('recipeIngredients').value.split('\n').filter(line => line.trim());
                const instructions = document.getElementById('recipeInstructions').value.split('\n').filter(line => line.trim());
                const notes = document.getElementById('recipeNotes').value;

            if (!name) {
                showMessage('Vui lòng nhập tên công thức', 'error');
                return;
            }
                // Remove old recipe if editing
                if (document.getElementById('recipeId').value) {
                    Object.keys(recipes).forEach(sec => {
                        recipes[sec] = recipes[sec].filter(r => r.id !== id);
                    });
                    console.log(`Updated recipe: ${id}`);
                } else {
                    console.log(`Added recipe: ${id}`);
                }

            // Remove old recipe if editing
            if (document.getElementById('recipeId').value) {
                Object.keys(recipes).forEach(sec => {
                    recipes[sec] = recipes[sec].filter(r => r.id !== id);
                });
                // Add new or updated recipe
                if (!recipes[section]) recipes[section] = [];
                recipes[section].push({ id, name, ingredients, instructions, notes });
                localStorage.setItem('recipes', JSON.stringify(recipes)); // Ensure save after update
                renderRecipes();
                closeModal();
            } catch (e) {
                console.error('Error submitting form:', e);
}

            // Add new recipe
            if (!recipes[section]) recipes[section] = [];
            recipes[section].push({ 
                id, 
                name, 
                ingredients, 
                instructions, 
                notes 
            });
            
            saveRecipes();
            renderRecipes();
            closeModal();
            showMessage(
                document.getElementById('recipeId').value 
                    ? 'Đã cập nhật công thức!' 
                    : 'Đã thêm công thức mới!'
            );
});

        // Khởi tạo ứng dụng
        document.addEventListener('DOMContentLoaded', () => {
            loadRecipes();
        });
        // Initialize
        try {
            renderRecipes();
            console.log('Initial render complete');
        } catch (e) {
            console.error('Initial render failed:', e);
            localStorage.setItem('recipes', JSON.stringify(defaultRecipes));
            renderRecipes();
        }
</script>
</body>
</html>
